

# Dependency Management Rules

## Critical: Fixed Dependencies Only!

⚠️ **NEVER add new dependencies without approval!** ⚠️

### Allowed Dependencies
All allowed dependencies are listed in [allowed-mods.txt](mdc:allowed-mods.txt):

**Core Dependencies (Fixed Versions):**
- `github.com/mymmrac/telego v1.2.0` - Telegram API
- `github.com/openai/openai-go v1.11.1` - **CRITICAL: Must be v1.11.1, uses Responses API**
- `github.com/jackc/pgx/v5 v5.7.4` - PostgreSQL driver
- `github.com/ThreeDotsLabs/watermill v1.4.7` - Event streaming
- `github.com/samber/do v1.6.0` - Dependency injection
- `github.com/samber/lo v1.51.0` - Utility functions
- `github.com/pelletier/go-toml/v2 v2.2.4` - TOML configuration parsing

### Version Enforcement
```bash
# Check for unauthorized imports
make check-imports

# This command validates against allowed-mods.txt
go list -m all | grep -vFf allowed-mods.txt
```

### Adding New Dependencies
1. **STOP** - Get approval first!
2. Update [allowed-mods.txt](mdc:allowed-mods.txt)
3. Update [go.mod](mdc:go.mod) with exact version
4. Run `go mod tidy`
5. Test with `make check-imports`

### Critical API Usage

#### OpenAI v1.11.1 Responses API Patterns
```go
// Correct usage for v1.11.1 - Chat Completions (legacy compatibility)
resp, err := c.client.Chat.Completions.New(ctx, openai.ChatCompletionNewParams{
    Messages: []openai.ChatCompletionMessageParamUnion{
        openai.SystemMessage(prompt),
        openai.UserMessage(query),
    },
    Model:       openai.ChatModelGPT4o,        // Direct model enum
    MaxTokens:   openai.Int(2048),             // Use openai.Int!
    Temperature: openai.Float(0.7),            // Use openai.Float!
})

// NEW Responses API (preferred for conversation context)
resp, err := c.client.Responses.New(ctx, responses.ResponseNewParams{
    Model: openai.ChatModelGPT4o,
    Input: responses.ResponseNewParamsInputUnion{
        OfInputItemList: input,
    },
    Instructions:       openai.String(instructions),
    PreviousResponseID: openai.String(responseID), // For conversation continuity
    Store:              openai.Bool(true),
})
```

#### Telego v1.2.0 Patterns
```go
// Context required for all API calls
updates, err := l.bot.UpdatesViaLongPolling(ctx, nil)
botInfo, err := l.bot.GetMe(ctx)
```

### Forbidden Actions
- ❌ `go get` new packages without approval
- ❌ Updating existing package versions
- ❌ Using different OpenAI client versions
- ❌ Alternative Telegram libraries
- ❌ Different SQL drivers than pgx/v5

- ❌ Alternative Telegram libraries
- ❌ Different SQL drivers than pgx/v5
